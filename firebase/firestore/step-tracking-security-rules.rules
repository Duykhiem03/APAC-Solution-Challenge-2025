rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /steps/{document} {
      // Users can read their own step data and leaderboard data
      allow read: if 
        (request.auth.uid != null && 
        (resource.data.userId == request.auth.uid || 
         resource.data.isPublic == true));

      // Users can only write their own step data
      allow write: if 
        request.auth.uid != null &&
        request.resource.data.userId == request.auth.uid &&
        validateStepData(request.resource.data);
    }

    function validateStepData(data) {
      let requiredFields = ['userId', 'date', 'steps', 'duration', 'lastUpdated'];
      let hasAllFields = requiredFields.all(field => data[field] != null);
      
      return hasAllFields &&
        data.steps is number &&
        data.steps >= 0 &&
        data.duration is number &&
        data.duration >= 0;
    }
  }
}
